---
title: "Simulations for 'Treatment effec estimation with missing attributes'"
author:
  - Imke Mayer^[EHESS, imke.mayer@ehess.fr]
  - Julie Josse^[Inria]
date: "March 2021"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
abstract: | 
  This notebook allows to replicate the simulations for the paper under review *Treatment effect estimation with missing attributes*. With this notebook you can generate simulations and estimate treatment effects with incomplete covariates obtained with different missingness mechanisms and proportions of missing values.
---

# Preliminaries
```{r setup}
knitr::opts_chunk$set(echo = TRUE, verbose = FALSE, warning = FALSE, message=FALSE, cache = FALSE)

# Clear any existing variables
rm(list = ls())

# Set seed for reproducibility
set.seed(1234)

# If not installed yet, you need to un-comment the following line once to install
# the genRCT package that allows to use the calibration weighting (CW) estimator
# install.packages("genRCT_0.1.0.tar.gz", repos = NULL)
access_genRCT <- require(genRCT)   # calibration weighting estimator, implementation by Dong et al.

# Load implemented estimation functions from GitLab repository
if (access_genRCT) {
  source("estimators_and_simulations.R")
} else {
  source("estimators_and_simulations_wo_cw.R")
}

results_dir <- "./results/"
fig_dir <- "./figures/"
```


```{r load_libraries}
# Libraries
library(ggplot2)      # plots
library(dplyr)        # data frame tools
library(table1)       # table for baseline
library(wesanderson)  # colors
library(naniar)       # visualize missing data

# number of repetitions in simulation
repetitions = 20
repetitions_long = 20 # to speed up the running time, reduce this number that sets the number of repetitions for the slower methods (em, grf and mice)
fig_prefix <- paste0("rep", repetitions)
fig_prefix_long <- paste0("rep", repetitions_long)

n_range <- 1000*1:5

fig_prefix <- paste0("rep", repetitions, "_n", paste(n_range, sep="", collapse="_"))
fig_prefix_long <- paste0("rep", repetitions_long, "_n", paste(n_range, sep="", collapse="_"))

# For every possible choice of options (repetitions, repetitions_long, link, corX, rho, snr, etc.) the results will be computed and saved in the `results_dir` path.
# By default we assume the results have not yet been computed and saved
results_exist <- FALSE
```

Some of the options are kept fixed in these simulations but could be changed to alternative values.

```{r set_options}
# link function for outcome and selection score. 
link <- links <- "linear" # alternatively, could be set to "non-linear"

# correlation coefficient for covariates
corX <- TRUE
rho <- 0.6 
if (corX) {
  Sigma <- diag(1-rho, ncol = 4, nrow = 4) + matrix(rho, nrow = 4, ncol = 4)
} else {
  Sigma <- diag(4)
}

# off-set in selection score model
bs0 <- ifelse(identical(Sigma,diag(nrow(Sigma))), ifelse(link=="linear", -2.5, -0.92), ifelse(link=="linear", -3.1, -2.2))

# signal-to-noise ratio for selection score and outcome model
snr <- 5
```

# Note on distributional shift

We first show a small example how the data looks like and visualize the distributional shift between the RCT and the target population.

```{r simulate_example}
one_simulation <- simulate_continuous(n = 1000, m = 10000,  link=link, Sigma=Sigma, bs0=bs0,
                                      na_rct=list(mechanism="MNAR", prop_miss=0.2, idx_incomplete=rep(1,4), cis=F, cio=F),
                                      na_rwe=list(mechanism="MNAR_selfmask", prop_miss=c(0.5, 0.1, 0.1, 0.1), idx_incomplete=rep(1,4), cio=F))
tau <- one_simulation$tau
one_simulation <- one_simulation$DF
sum(one_simulation$V==1)
one_simulation$sample <- ifelse(one_simulation$V == 1, "RCT", "Observational")
baseline <- table1(~ X1 + X2 + X3 + X4 | sample, data = one_simulation, overall="Total")
baseline
```


```{r plot_example}
ggplot(one_simulation, aes(x = X1, group = sample, fill = sample)) +
    geom_histogram(binwidth = 0.2, alpha=0.4, position="dodge") + 
        scale_fill_manual(values=c("darkorchid4", "darkorange1")) +
    theme_classic() +
    theme(legend.title = element_blank(), legend.position = "bottom", 
          legend.box = "horizontal", legend.text = element_text(size=13, 
                                     face="bold")) +
  ylab("") +  # no title in legend
     theme(axis.text = element_text(vjust = 0.5, hjust=1, size=14, face="bold"),
           axis.title.x = element_text(size=18, face="bold"))
```

We can check that the missing values are differently distributed in the two studies:

```{r gg_miss_example}
gg_miss_upset(one_simulation[,!names(one_simulation) %in% c("A", "Y")])

gg_miss_fct(x = one_simulation[,!names(one_simulation) %in% c("A", "Y")], fct = V)
```


# Simulation setting

We use the following simulation setting (see the [submitted paper]() for more details):

$$\operatorname{logit}\left\{\pi_{V}(X)\right\}=-2.5-0.5 X_{1}-0.3 X_{2}-0.5 X_{3}-0.4 X_{4},$$
where every $X_j$ is drawn from a normal distribution $\mathcal{N}(1,1)$. This model specifies the trial selection, $V$.

Unless specified differently, the outcome is generated as follows:

$$Y(a)=-100+27.4 a X_{1}+13.7 X_{2}+13.7 X_{3}+13.7 X_{4}+\epsilon \quad \text{ with }\epsilon \sim \mathcal{N}(0,1)$$
and the missing covariate values, indexed by the mask $M=1-R\in\{0,1\}^{n\times p}$, are sampled using one of the three mechanisms below:

- MCAR such that $P(M_{ij}=1)=0.02$;
- MAR such that $P(M_{i,j}=1|X_{i,-j})=0.2$.
- MNAR such that $P(M_{i,j}=1|X_{i,j})$ depends on $X_{i,j}$ for each $j$.


We do not modify the treatment assignment mechanism since by assumption it is independent of everything and generally constant for all individuals ($e_1(x)=e_1=0.5$).


# Classical ignorability + missingness assumptions 

Below, we compare the methods in the setting where we assume the classical ignorability from the full data case and make assumptions about the missing values mechansism.

In practice that means that the missing values occur afterward after inclusion and randomization.

## MCAR

```{r noCIS_noCIO_MCAR}
prop.miss <- 0.2
mechanism <- "MCAR"
```

### On full data

```{r loadData_full_noCIS_MCAR, echo=F, message=F, warning=F}
methods <- c("glm", "grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_full_noCIS_MCAR}
methods <- c("glm", "grf")
if (!results_exist) {
  results_full <- c()
  for (link in links){
    for (n in n_range){
    tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                        p = 4, Sigma = Sigma, snr=snr,
                                        na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                        method=methods, nb_strat=1,
                                        complete_cases=TRUE, full_data=T,
                                        verbose=T,verbose_intern = F)
    tmp$n <- n
    tmp$link <- link
    results_full <- rbind(results_full, tmp)
    }
  }
}
```

```{r save_full_noCIS_MCAR, echo=F, message=F, warning=F}
if (!results_exist){
  save(results_full, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_full_noCIS_MCAR, echo=F, message=F}
tmp <- results_full %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT){
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable, linetype=as.factor(method))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using full data, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE,
           linetype=guide_legend(nrow=1,byrow=T)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-full-glm-grf.pdf"), 
       width=8.8, height=6.8)
```

### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MCAR, echo=F, message=F, warning=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_cc_noCIS_MCAR}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
    tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                        p = 4, Sigma = Sigma, snr = snr,
                                        na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                        method=methods, nb_strat=1,
                                        complete_cases=TRUE,
                                        verbose=T,verbose_intern = F)
    tmp$n <- n
    tmp$link <- link
    results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MCAR, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MCAR, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT){
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-cc.pdf"), 
       width=8.8, height=6.8)
```


### Use EM to handle incomplete cases

Now we do not throw away incomplete observations but rather adapt the estimation methods to take them into account.
We start by using EM to handle (ignorable) missing values in linear and logistic regressions.


```{r loadData_em_noCIS_MCAR, echo=F, message=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_em_noCIS_MCAR}
methods <- c("glm")

if (!results_exist) {
  results_em <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method="glm", nb_strat=1,
                                          complete_cases=F,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_em <- rbind(results_em, tmp)
    }
  }
}
```

```{r save_em_noCIS_MCAR, echo=F}
if (!results_exist){
  save(results_em, file=paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_em_noCIS_MCAR, echo=F}
tmp <- results_em %>% group_by(link) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using EM, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-noCIS-em.pdf"), width=8.8, height=6.8)
```


### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MCAR, echo=F, message=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MCAR}
methods <- c("grf")

if (!results_exist) {
  results_grf <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=FALSE,
                                          verbose=T)
        tmp$n <- n
        tmp$link <- link
        results_grf <- rbind(results_grf, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MCAR, echo=F}
if (!results_exist) {
  save(results_grf, file=paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MCAR, echo=F}
tmp <- results_grf %>% group_by(link,n) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "tau", "n", "link", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip()  + 
    facet_grid(.~n, scales = "free")

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-noCIS-mia.pdf"), width=8.8, height=6.8)
```


### Use within-study multiple imputation

```{r loadData_mi_noCIS_MCAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mi_noCIS_MCAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mi <- rbind(results_mi, tmp)
    }
  }
}
```

```{r save_mi_noCIS_MCAR, echo=F}
if (!results_exist){
  save(results_mi, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_noCIS_MCAR, echo=F}
tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT){
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using within-study MI, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-mi.pdf"), width=8.8, height=6.8)
```


### Use multilevel multiple imputation with micemd

```{r loadData_mlmi_noCIS_MCAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MCAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi_alt <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                        p = 4, Sigma = Sigma, snr=snr,
                                        na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                        method=methods, nb_strat=1,
                                        do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                        verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      tmp$strategy <- "multi-level-woY"
      results_mi_alt <- rbind(results_mi_alt, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MCAR, echo=F}
if (!results_exist){
  save(results_mi_alt, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MCAR, echo=F}
tmp <- results_mi_alt %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT){
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) +
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-multilevel-mi.pdf"), width=8.8, height=6.8)
```


## MAR

```{r noCIS_MAR}
prop.miss <- 0.2
mechanism <- "MAR"
```

### On full data

```{r loadData_full_noCIS_MAR, echo=F}
methods <- c("glm","grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_full_noCIS_MAR}
methods <- c("glm","grf")

if (!results_exist) {
  results_full <- c()
  for (link in links){
    for (n in n_range){
    tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                        p = 4, Sigma = Sigma, snr=snr,
                                        na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                        method=methods, nb_strat=1,
                                        complete_cases=TRUE, full_data=T,
                                        verbose=T,verbose_intern = F)
    tmp$n <- n
    tmp$link <- link
    results_full <- rbind(results_full, tmp)
    }
  }
}
```

```{r save_full_noCIS_MAR, echo=F}
if (!results_exist) {
  save(results_full, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_full_noCIS_MAR, echo=F}
tmp <- results_full %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable, linetype=as.factor(method))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using full data, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE,
           linetype=guide_legend(nrow=1,byrow=T)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-full-glm-grf.pdf"), 
       width=8.8, height=6.8
       #,device=cairo_ps, fallback_resolution = 200
       )
```

### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_noCIS_MAR}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MAR, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_noCIO_MAR, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% 
        group_by(method, n, link, variable) %>% 
        mutate(bias=mean(value)-mean(tau)) %>% 
        ungroup() %>% 
        dplyr::select(c("variable", "bias", "n", "method", "link")) %>% 
        filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-cc.pdf"), 
       width=8.8, height=6.8)
```

### Use EM to handle incomplete cases

```{r loadData_em_noCIS_MAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_em_noCIS_MAR}
methods <- c("glm")

if (!results_exist) {
  results_em <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method="glm", nb_strat=1, 
                                          complete_cases=F,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_em <- rbind(results_em, tmp)
    }
  }
}
```

```{r save_em_noCIS_MAR, echo=F}
if (!results_exist) {
  save(results_em, file=paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_em_noCIS_MAR, echo=F}
tmp <- results_em %>% group_by(link) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using EM, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-noCIS-em.pdf"), 
       width=8.8, height=6.8)
```

### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MAR, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mia_noCIS_MAR}
methods <- c("grf")

if (!results_exist) {
  results_grf <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=FALSE,
                                          verbose=T)
      tmp$n <- n
      tmp$link <- link
      results_grf <- rbind(results_grf, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MAR, echo=F}
if (!results_exist) {
  save(results_grf, file=paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_noCIO_MAR, echo=F}
tmp <- results_grf %>% group_by(link,n) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "tau", "n", "link", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

paste0("results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip()  + 
    facet_grid(.~n, scales = "free")

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-noCIS-mia.pdf"), width=8.8, height=6.8)
```


### Use within-study multiple imputation

```{r loadData_mi_noCIS_MAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mi_noCIS_MAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    bs0 <- ifelse(identical(Sigma,diag(nrow(Sigma))), ifelse(link=="linear", -2.5, -0.92), ifelse(link=="linear", -3.1, -2.2))
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, bin="quantile",
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mi <- rbind(results_mi, tmp)
    }
  }
}
```

```{r save_mi_noCIS_MAR, echo=F}
if (!results_exist) {
save(results_mi, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_noCIS_MAR, echo=F}
tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using within-study MI, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-mi.pdf"), 
       width=8.8, height=6.8)
```


### Use multilevel multiple imputation with micemd

```{r loadData_mlmi_noCIS_MAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi_alt <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      tmp$strategy <- "multi-level-woY"
      results_mi_alt <- rbind(results_mi_alt, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MAR, echo=F}
if (!results_exist) {
  save(results_mi_alt, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MAR, echo=F}
tmp <- results_mi_alt %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

print(paste0("results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +  
    guides(fill=FALSE) +
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


## MNAR (self-mask)

```{r noCIS_MNAR}
prop.miss <- 0.2
mechanism <- "MNAR_selfmask"
```

### On full data

```{r loadData_full_noCIS_MNAR, echo=F}
methods <- c("glm", "grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_full_noCIS_MNAR}
methods <- c("glm", "grf")

if (!results_exist) {
  results_full <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, 
                                          complete_cases=TRUE, full_data=T,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_full <- rbind(results_full, tmp)
    }
  }
}
```

```{r save_full_noCIS_MNAR, echo=F}
if (!results_exist) {
  save(results_full, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_full_noCIS_MNAR, echo=F}
tmp <- results_full %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable, linetype=as.factor(method))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using full data, under MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE,
           linetype=guide_legend(nrow=1,byrow=T)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-full-grf.pdf"), 
       width=8.8, height=6.8)
```

### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MNA, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_noCIS_MNAR}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MNAR, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MNAR, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-cc.pdf"), 
       width=8.8, height=6.8)
```


### Use EM to handle incomplete cases

```{r loadData_em_noCIS_MNAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_em_noCIS_MNAR}
methods <- c("glm")

if (!results_exist) {
  results_em <- c()
  for (link in links){
    for (n in n_range){
      tmp <- NULL
      try(tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method="glm", nb_strat=1,
                                          complete_cases=F,
                                          verbose=T,verbose_intern = F))
      if (!is.null(tmp)){
      tmp$n <- n
      tmp$link <- link
      results_em <- rbind(results_em, tmp)
      }
    }
  }
}
```

```{r save_em_noCIS_MNAR, echo=F}
if (!results_exist) {
  save(results_em, file=paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_em_noCIS_MNAR, echo=F}
if (!is.null(results_em)){
  tmp <- results_em %>% group_by(link) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()
  
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
  
  tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
  print(paste0( "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_")))
  print(tt) 

  ggplot(data = tmp, aes(x = variable, y = value)) +  
      geom_boxplot(aes(fill=variable), show.legend = F) +
      theme_bw() +
      geom_hline(aes(yintercept = tau, color = "Population ATE"), 
                 size = 0.6, linetype="dashed") +
      xlab("") +
      ylab(paste0("Estimated ATE using EM, under MNAR")) + #
      theme(legend.title = element_blank(), 
            legend.text = element_text(size=14)) +  
      theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                     hjust=1, size=14)) + 
      theme(legend.key = element_rect(color = NA, fill = NA),           
            legend.position="bottom",           
            legend.box="vertical", legend.margin=margin(),           
            legend.key.size = unit(1, "cm")) +      
      guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
      scale_fill_brewer(palette = "Accent") +
      coord_flip() + 
      facet_grid(.~n)
  
  ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-noCIS-em.pdf"), 
         width=8.8, height=6.8)
}
```


### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MNAR, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MNAR}
methods <- c("grf")

if (!results_exist) {
  results_grf <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=FALSE,
                                          verbose=T)
      tmp$n <- n
      tmp$link <- link
      results_grf <- rbind(results_grf, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MNAR, echo=F}
if (!results_exist) {
  save(results_grf, file=paste0(results_dir, "results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MNAR, echo=F}
tmp <- results_grf %>% group_by(link,n) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "tau", "n", "link", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions_long, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip()  + 
    facet_grid(.~n, scales = "free")

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```


### Use within-study multiple imputation

```{r loadData_mi_noCIS_MNAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mi_noCIS_MNAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- NULL
      try(tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F))
      if (!is.null(tmp)){
        tmp$n <- n
        tmp$link <- link
        results_mi <- rbind(results_mi, tmp)
      }
    }
  }
}
```

```{r save_mi_noCIS_MNAR, echo=F}
if (!results_exist) {
  save(results_mi, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_noCIS_MNAR, echo=F}
if (!is.null(results_mi)){
  tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()
  
  if (access_genRCT) {
    tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
    tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
    tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
  } else {
    tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
    tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
    tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
  }
  
  tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
  print(tt)
  ggplot(data = tmp, aes(x = variable, y = value)) + 
      geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
      theme_bw() +
      geom_hline(aes(yintercept = tau, color = "Population ATE"), 
                 size = 0.6, linetype="dashed") +
      xlab("") +
      ylab(paste0("Estimated ATE using within-study MI, under MNAR")) + #
      theme(legend.title = element_blank(), 
            legend.text = element_text(size=14)) +  
      theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                     hjust=1, size=14)) + 
      theme(legend.key = element_rect(color = NA, fill = NA),           
            legend.position="bottom",           
            legend.box="vertical", legend.margin=margin(),           
            legend.key.size = unit(1, "cm")) +      
      guides(fill=FALSE) +         
      scale_fill_brewer(palette = "Accent") +
      coord_flip() + 
      facet_grid(.~n)
  
  ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-mi.pdf"), 
         width=8.8, height=6.8)
}
```


### Use multilevel multiple imputation with micemd

```{r loadData_mlmi_noCIS_MNAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mlmi_noCIS_MNAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi_alt <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      tmp$strategy <- "multi-level-woY"
      results_mi_alt <- rbind(results_mi_alt, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MNAR, echo=F}
if (!results_exist) {
  save(results_mi_alt, file=paste0(results_dir, "results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MNAR, echo=F}
tmp <- results_mi_alt %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(paste0("results_rep",repetitions, "_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```

# Conditional independence of selection (CIS)

## MCAR

```{r CIS_MCAR}
prop.miss <- 0.2
mechanism <- "MCAR"
```


### On full data

```{r loadData_full_CIS_MCAR, echo=F}
methods <- c("glm", "grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_full_CIS_MCAR}
methods <- c("glm")

if (!results_exist) {
  results_full <- c()
  for (link in links){
    for (n in n_range){
    tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                        p = 4, Sigma = Sigma, snr=snr,
                                        na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                        na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                        method=methods, nb_strat=1,
                                        complete_cases=TRUE, full_data=T,
                                        verbose=T,verbose_intern = F)
    tmp$n <- n
    tmp$link <- link
    results_full <- rbind(results_full, tmp)
    }
  }
}
```

```{r save_full_CIS_MCAR, echo=F}
if (!results_exist) {
  save(results_full, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_full_CIS_MCAR, echo=F}
tmp <- results_full %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(method))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using full data, under CIS and MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),
          legend.position="bottom",
          legend.box="vertical", legend.margin=margin(),
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE,
           linetype=guide_legend(nrow=1,byrow=T)) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-full-glm-grf.pdf"), 
       width=8.8, height=6.8)
```

### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_CIS_MCAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_CIS_MCAR}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_CIS_MCAR, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_CIS_MCAR, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable), show.legend=F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under CIS and MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) +
    theme(legend.key = element_rect(color = NA, fill = NA),
          legend.position="bottom",
          legend.box="vertical", legend.margin=margin(),
          legend.key.size = unit(1, "cm")) + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-cc.pdf"), 
       width=8.8, height=6.8)
```

### Use EM to handle incomplete cases

```{r loadData_em_CIS_MCAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_em_CIS_MCAR}
methods <- c("glm")

if (!results_exist) {
  results_em <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method="glm", nb_strat=1,
                                          complete_cases=F,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_em <- rbind(results_em, tmp)
    }
  }
}
```

```{r save_em_CIS_MCAR, echo=F}
if (!results_exist) {
  save(results_em, file=paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_em_CIS_MCAR, echo=F}
tmp <- results_em %>% group_by(link) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using EM, under CIS and MCAR")) + 
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),
          legend.position="bottom",
          legend.box="vertical", legend.margin=margin(),
          legend.key.size = unit(1, "cm")) + 
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-CIS-em.pdf"), 
       width=8.8, height=6.8)
```

### Use MIA to handle incomplete cases

```{r loadData_mia_CIS_MCAR, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mia_CIS_MCAR}
methods <- c("grf")

if (!results_exist) {
  results_grf <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=FALSE,
                                          verbose=T)
      tmp$n <- n
      tmp$link <- link
      results_grf <- rbind(results_grf, tmp)
    }
  }
}
```

```{r save_mia_CIS_MCAR, echo=F}
if (!results_exist) {
  save(results_grf, file=paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_CIS_MCAR, echo=F}
tmp <- results_grf %>% group_by(link,n) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "tau", "n", "link", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under CIS and MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
        legend.position="bottom",           
        legend.box="vertical", legend.margin=margin(),           
        legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip()  + 
    facet_grid(.~n, scales = "free")

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-CIS-mia.pdf"), 
       width=8.8, height=6.8)
```

### Use within-study multiple imputation

```{r loadData_mi_CIS_MCAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mi_CIS_MCAR}
methods <- c("glm")

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_rct=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mi <- rbind(results_mi, tmp)
    }
  }
}
```

```{r save_mi_CIS_MCAR, echo=F}
if (!results_exist) {
  save(results_mi, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_CIS_MCAR, echo=F}
tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable, nb_mi) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link", "nb_mi")) %>% filter(nb_mi==10) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using within-study MI, under CIS and MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-mi.pdf"), 
       width=8.8, height=6.8)
```

### Use multilevel multiple imputation with micemd

```{r loadData_mlmi_CIS_MCAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_CIS_MCAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi_alt <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      tmp$strategy <- "multi-level-woY"
      results_mi_alt <- rbind(results_mi_alt, tmp)
    }
  }
}
```

```{r save_mlmi_CIS_MCAR, echo=F}
if(!results_exist) {
  save(results_mi_alt, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_CIS_MCAR, echo=F}
tmp <- results_mi_alt %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under CIS and MCAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) +
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


## MAR

```{r CIS_MAR}
prop.miss <- 0.2
mechanism <- "MAR"
```

### On full data

```{r loadData_full_CIS_MAR, echo=F}
methods <- c("glm", "grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_full_CIS_MAR}
methods <- c("glm", "grf")

if (!results_exist) {
  results_full <- c()
  for (link in links){
    for (n in n_range){
    tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                        p = 4, Sigma = Sigma, snr=snr,
                                        na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                        na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                        method=methods, nb_strat=1,
                                        complete_cases=TRUE, full_data=T,
                                        verbose=T,verbose_intern = F)
    tmp$n <- n
    tmp$link <- link
    results_full <- rbind(results_full, tmp)
    }
  }
}
```

```{r save_full_noCIO_MAR, echo=F}
if (!results_exist) {
  save(results_full, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_full_noCIO_MAR, echo=F}
tmp <- results_full %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable, linetype=as.factor(method))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using full data, under CIS and MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +  
    guides(fill=FALSE,
           linetype=guide_legend(nrow=1,byrow=T)) +        
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-full-glm-grf.pdf"), 
       width=8.8, height=6.8)
```

### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_CIS_MAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_CIS_MAR}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_CIS_MAR, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_CIS_MAR, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under CIS and MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-cc.pdf"), 
       width=8.8, height=6.8)
```

### Use EM to handle incomplete cases

```{r loadData_em_CIS_MAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_em_CIS_MAR}
methods <- c("glm")

if (!results_exist) {
  results_em <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method="glm", nb_strat=1,
                                          complete_cases=F,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_em <- rbind(results_em, tmp)
    }
  }
}
```

```{r save_em_CIS_MAR, echo=F}
if(!results_exist) {
  save(results_em, file=paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_em_CIS_MAR, echo=F}
tmp <- results_em %>% group_by(link) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using EM, under CIS and MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-CIS-em.pdf"), 
       width=8.8, height=6.8)
```

### Use MIA to handle incomplete cases

```{r loadData_mia_CIS_MAR, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mia_CIS_MAR}
methods <- c("grf")

if (!results_exist) {
  results_grf <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1, 
                                          complete_cases=FALSE,
                                          verbose=T)
      tmp$n <- n
      tmp$link <- link
      results_grf <- rbind(results_grf, tmp)
    }
  }
}
```

```{r save_mia_CIS_MAR, echo=F}
if (!results_exist) {
  save(results_grf, file=paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_CIS_MAR, echo=F}
tmp <- results_grf %>% group_by(link,n) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "tau", "n", "link", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under CIS and MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip()  + 
    facet_grid(.~n, scales = "free")

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-CIS-mia.pdf"), 
       width=8.8, height=6.8)
```

### Use within-study multiple imputation

```{r loadData_mi_CIS_MAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mi_CIS_MAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_rct=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mi <- rbind(results_mi, tmp)
    }
  }
}
```

```{r save_mi_CIS_MAR, echo=F}
if (!results_exist) {
  save(results_mi, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_CIS_MAR, echo=F}
tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using within-study MI, under CIS and MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-mi.pdf"), 
       width=8.8, height=6.8)
```

### Use multilevel multiple imputation with micemd

```{r loadData_mlmi_CIS_MAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_CIS_MAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi_alt <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      tmp$strategy <- "multi-level-woY"
      results_mi_alt <- rbind(results_mi_alt, tmp)
    }
  }
}
```

```{r save_mlmi_CIS_MAR, echo=F}
if (!results_exist) {
  save(results_mi_alt, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_CIS_MAR, echo=F}
tmp <- results_mi_alt %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_CIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under CIS and MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) +
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


## MNAR (self-mask)

```{r CIS_MNAR}
prop.miss <- 0.2
mechanism <- "MNAR_selfmask"
```

### On full data

```{r loadData_full_CIS_MNAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_full_CIS_MNAR}
methods <- c("glm", "grf")

if (!results_exist) {
  results_full <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE, full_data=T,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_full <- rbind(results_full, tmp)
    }
  }
}
```

```{r save_full_CIS_MNAR, echo=F}
if (!results_exist) {
  save(results_full, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_full_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_full_CIS_MNAR, echo=F}
tmp <- results_full %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable, ilnetype = as.factor(method))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using full data, under CIS and MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE,
           linetype=guide_legend(nrow=1,byrow=T)) +       
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-full-glm-grf.pdf"), 
       width=8.8, height=6.8)
```

### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_CIS_MNAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_cc_CIS_MNAR}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_CIS_MNAR, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_CIS_MNAR, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW")) 
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under CIS and MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-cc.pdf"), 
       width=8.8, height=6.8)
```


### Use EM to handle incomplete cases

```{r loadData_em_CIS_MNAR, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_em_CIS_MNAR}
methods <- c("glm")

if (!results_exist) {
  results_em <- c()
  for (link in links){
    for (n in n_range){
      tmp <- NULL
      try(tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method="glm", nb_strat=1,
                                          complete_cases=F,
                                          verbose=T,verbose_intern = F))
      if (!is.null(tmp)){
        tmp$n <- n
        tmp$link <- link
        results_em <- rbind(results_em, tmp)
      }
    }
  }
}
```

```{r save_em_CIS_MNAR, echo=F}
if (!results_exist) {
  save(results_em, file=paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_em_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_em_CIS_MNAR, echo=F}
if (!is.null(results_em)){
  tmp <- results_em %>% group_by(link) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()
  
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 
  
  tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
  print(tt) 
  
  ggplot(data = tmp, aes(x = variable, y = value)) +  
      geom_boxplot(aes(fill=variable), show.legend = F) +
      theme_bw() +
      geom_hline(aes(yintercept = tau, color = "Population ATE"), 
                 size = 0.6, linetype="dashed") +
      xlab("") +
      ylab(paste0("Estimated ATE using EM, under CIS and MNAR")) + #
      theme(legend.title = element_blank(), 
            legend.text = element_text(size=14)) +  
      theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                     hjust=1, size=14)) + 
      theme(legend.key = element_rect(color = NA, fill = NA),           
            legend.position="bottom",           
            legend.box="vertical", legend.margin=margin(),           
            legend.key.size = unit(1, "cm")) +      
      guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
      scale_fill_brewer(palette = "Accent") +
      coord_flip() + 
      facet_grid(.~n)
  
  ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-CIS-em.pdf"), 
         width=8.8, height=6.8)
} else {
  print("EM did not converge in any case of this scenario.")
}
```


### Use MIA to handle incomplete cases

```{r loadData_mia_CIS_MNAR, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mia_CIS_MNAR}
methods <- c("grf")

if (!results_exist) {
  results_grf <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=FALSE,
                                          verbose=T)
      tmp$n <- n
      tmp$link <- link
      results_grf <- rbind(results_grf, tmp)
    }
  }
}
```

```{r save_mia_CIS_MNAR, echo=F}
if (!results_exist) {
  save(results_grf, file=paste0(results_dir, "results_rep",repetitions_long, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_CIS_MNAR, echo=F}
tmp <- results_grf %>% group_by(link,n) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "tau", "n", "link", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW")) 

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under CIS and MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip()  + 
    facet_grid(.~n, scales = "free")

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-",mechanism,"-corX",corX,"-CIS-mia.pdf"), 
       width=8.8, height=6.8)
```


### Use within-study multiple imputation

```{r loadData_mi_CIS_MNAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mi_CIS_MNAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mi <- rbind(results_mi, tmp)
    }
  }
}
```

```{r save_mi_CIS_MNAR, echo=F}
if (!results_exist) {
  save(results_mi, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_CIS_MNAR, echo=F}
tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using within-study MI, under CIS and MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-mi.pdf"), 
       width=8.8, height=6.8)
```

### Use multilevel multiple imputation with micemd

```{r loadData_mlmi_CIS_MNAR, echo=F}
methods <- c("glm")
nb_mi <- c(5, 10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_CIS_MNAR}
methods <- c("glm")
nb_mi <- c(5, 10)

if (!results_exist) {
  results_mi_alt <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=T, cio=F),
                                          na_rwe=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      tmp$strategy <- "multi-level-woY"
      results_mi_alt <- rbind(results_mi_alt, tmp)
    }
  }
}
```

```{r save_mlmi_CIS_MNAR, echo=F}
if (!results_exist) {
  save(results_mi_alt, file=paste0(results_dir, "results_rep",repetitions, "_CIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_CIS_MNAR, echo=F}
tmp <- results_mi_alt %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_CIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under CIS and MNAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) +
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",mechanism,"-corX",corX,"-CIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


# Other settings

## Impact of number of multiple imputations

```{r loadData_mi_noCIS_MCAR_largeM, echo=F}
mechanism <- "MCAR"
methods <- c("glm")
nb_mi <- c(5, 10, 50)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(c(1000,2000),sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(c(1000,2000),sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mi_noCIS_MCAR_largeM}
mechanism <- "MCAR"
methods <- c("glm")
nb_mi <- c(10, 50)

if (!results_exist) {
  results_mi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = 3, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr = snr,
                                          na_df=list(mechanism=mechanism, prop_miss=prop.miss, idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          do_mi=T, nb_mi=nb_mi,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mi <- rbind(results_mi, tmp)
    }
  }
}
```

```{r save_mi_noCIS_MCAR_largeM, echo=F}
if (!results_exist) {
  save(results_mi, paste0(results_dir, "results_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(c(1000,2000),sep="",collapse="_"), "_mi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mi_noCIS_MCAR_largeM, echo=F}
tmp <- results_mi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-6):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using within-study MI, under MCAR"))+
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=FALSE) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_simulation-MCAR-corXTRUE-noCIS-mi-largeM.pdf"), 
       width=8.8, height=6.8)
```

## Impact of different proportions in different data

### RCT: MCAR 0.1, RWE: MCAR 0.5

```{r}
mechanism <- c("MCAR","MCAR")
prop.miss <- c(0.1, 0.5)
```

#### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_noCIS_MCAR_rctMCAR01_rweMCAR05}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_",paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under CIS and without CIO")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"), "-corX",corX,"-diffpropNA-noCIS-cc.pdf"), 
       width=8.8, height=6.8)
```


#### Use multilevel MI

```{r loadData_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
methods <- c("glm")
nb_mi <- c(5,10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05}
methods <- c("glm")
nb_mi <- c(5,10)

if (!results_exist) {
  results_mlmi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
          
  method=methods, nb_strat=1,
                                            do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                            verbose=T, verbose_intern = F)
      tmp$strategy <- "multi-level-woY"
      tmp$n <- n
      tmp$link <- link
      results_mlmi <- rbind(results_mlmi, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
if (!results_exist) {
  save(results_mlmi, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
tmp <- results_mlmi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


#### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MCAR_rctMCAR01_rweMCAR05}
methods <- c("grf")

if (!results_exist) {
  results_mia <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mia <- rbind(results_mia, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
if (!results_exist) {
  save(results_mia, file=paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MCAR_rctMCAR01_rweMCAR05, echo=F}
tmp <- results_mia %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method",  "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable)) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```

### RCT: MCAR 0.05, RWE: MCAR 0.22

```{r}
mechanism <- c("MCAR","MCAR")
prop.miss <- c(0.05, 0.22)
```

#### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_cc_noCIS_MCAR_rctMCAR_rweMCAR_total02}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_ccnoCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW" ,"AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"), "-corX", corX,"-diffpropNA-noCIS-cc.pdf"),
       width=8.8, height=6.8)
```


#### Use multilevel MI

```{r loadData_mlmi_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
methods <- c("glm")
nb_mi <- c(5,10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mlmi_noCIS_MCAR_rctMCAR_rweMCAR_total02}
methods <- c("glm")
nb_mi <- c(5,10)

if (!results_exist) {
  results_mlmi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
          
  method=methods, nb_strat=1,
                                            do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                            verbose=T, verbose_intern = F)
      tmp$strategy <- "multi-level-woY"
      tmp$n <- n
      tmp$link <- link
      results_mlmi <- rbind(results_mlmi, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
if (!results_exist) {
  save(results_mlmi, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
tmp <- results_mlmi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MCAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


#### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MCAR_rctMCAR_rweMCAR_total02}
methods <- c("grf")

if (!results_exist) {
  results_mia <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, 
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mia <- rbind(results_mia, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
if (!results_exist) {
  save(results_mia, file=paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MCAR_rctMCAR_rweMCAR_total02, echo=F}
tmp <- results_mia %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias",  "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions_long, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable)) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```



### Equilibrated sample sizes - RCT: MCAR 0.1, RWE: MCAR 0.5

```{r}
mechanism <- c("MCAR","MCAR")
prop.miss <- c(0.1, 0.5)
```

#### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"), "-corX",corX,"-diffpropNA-samesize-noCIS-cc.pdf"), 
       width=8.8, height=6.8)
```

#### Use multilevel MI

```{r loadData_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
methods <- c("glm")
nb_mi <- c(5,10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize}
methods <- c("glm")
nb_mi <- c(5,10)

if (!results_exist) {
  results_mlmi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
          
  method=methods, nb_strat=1,
                                            do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                            verbose=T, verbose_intern = F)
      tmp$strategy <- "multi-level-woY"
      tmp$n <- n
      tmp$link <- link
      results_mlmi <- rbind(results_mlmi, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
if (!results_exist) {
  save(results_mlmi, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
tmp <- results_mlmi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_diffpropNA_samesize_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MCAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-samesize-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```

#### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize}
methods <- c("grf")

if (!results_exist) {
  results_mia <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mia <- rbind(results_mia, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
if (!results_exist) {
  save(results_mia, file=paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MCAR_rctMCAR01_rweMCAR05_samesize, echo=F}
tmp <- results_mia %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method",  "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias",  "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable)) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MCAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-samesize-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```


### RCT: MAR 0.1, RWE: MAR 0.5

```{r}
mechanism <- c("MAR","MAR")
prop.miss <- c(0.1, 0.5)
```

#### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_noCIS_MAR_rctMAR01_rweMAR05}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, 
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +  
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"), "-corX",corX,"-diffpropNA-noCIS-cc.pdf"), 
       width=8.8, height=6.8)
```


#### Use multilevel MI

```{r loadData_mlmi_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
methods <- c("glm")
nb_mi <- c(5,10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MAR_rctMAR01_rweMAR05}
methods <- c("glm")
nb_mi <- c(5,10)

if (!results_exist) {
  results_mlmi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
          
  method=methods, nb_strat=1,
                                            do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                            verbose=T, verbose_intern = F)
      tmp$strategy <- "multi-level-woY"
      tmp$n <- n
      tmp$link <- link
      results_mlmi <- rbind(results_mlmi, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
if (!results_exist) {
  save(results_mlmi, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
tmp <- results_mlmi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>%
  dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


#### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_",paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_mia_noCIS_MAR_rctMAR01_rweMAR05}
methods <- c("grf")

if (!results_exist) {
  results_mia <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mia <- rbind(results_mia, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
if (!results_exist) {
  save(results_mia, file=paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MAR_rctMAR01_rweMAR05, echo=F}
tmp <- results_mia %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias",  "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions_long, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable)) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```

### RCT: MAR 0.05, RWE: MAR 0.22

```{r}
mechanism <- c("MAR","MAR")
prop.miss <- c(0.05, 0.22)
```

#### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
}
```

```{r comp_cc_noCIS_MCAR_rctMAR_rweMAR_total02}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, 
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),          
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"), "-corX",corX,"-diffpropNA-noCIS-cc.pdf"),
       width=8.8, height=6.8)
```


#### Use multilevel MI

```{r loadData_mlmi_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
methods <- c("glm")
nb_mi <- c(5,10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MCAR_rctMAR_rweMAR_total02}
methods <- c("glm")
nb_mi <- c(5,10)

if (!results_exist) {
  results_mlmi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
          
  method=methods, nb_strat=1, 
                                            do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                            verbose=T, verbose_intern = F)
      tmp$strategy <- "multi-level-woY"
      tmp$n <- n
      tmp$link <- link
      results_mlmi <- rbind(results_mlmi, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
if (!results_exist) {
  save(results_mlmi, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
tmp <- results_mlmi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


#### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MCAR_rctMAR_rweMAR_total02}
methods <- c("grf")

if (!results_exist) {
  results_mia <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = 10*n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, 
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mia <- rbind(results_mia, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
if (!results_exist) {
  save(results_mia, file=paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MCAR_rctMAR_rweMAR_total02, echo=F}
tmp <- results_mia %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method",  "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions_long, "_diffpropNA_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable)) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MAR")) + 
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```


### Equilibrated sample sizes - RCT: MAR 0.1, RWE: MAR 0.5

```{r}
mechanism <- c("MAR","MAR")
prop.miss <- c(0.1, 0.5)
```

#### Use only complete cases (for logistic+linear regressions)

```{r loadData_cc_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
methods <- c("glm")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_cc_noCIS_MAR_rctMAR01_rweMAR05_samesize}
methods <- c("glm")

if (!results_exist) {
  results_cc <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1,
                                          complete_cases=TRUE,
                                          verbose=T,verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_cc <- rbind(results_cc, tmp)
    }
  }
}
```

```{r save_cc_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
if (!results_exist) {
  save(results_cc, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_cc_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
tmp <- results_cc %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) { 
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "n_effective", "m_effective")]
  tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n))) 
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "n", "method", "link")) %>% filter(n %in% c(min(n), max(n))) %>% unique() 

print(paste0("results_rep",repetitions, "_diffpropNA_samesize_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_cc_", paste(methods,sep="",collapse="_")))
print(tt) 

ggplot(data = tmp, aes(x = variable, y = value)) +  
    geom_boxplot(aes(fill=variable), show.legend = F) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using complete cases, under MAR")) + #
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),           
          legend.key.size = unit(1, "cm")) +      
    guides(fill=guide_legend(nrow=2,byrow=TRUE)) +         
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-",paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"), "-corX",corX,"-diffpropNA-samesize-noCIS-cc.pdf"),
       width=8.8, height=6.8)
```


#### Use multilevel MI

```{r loadData_mlmi_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
methods <- c("glm")
nb_mi <- c(5,10)
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mlmi_noCIS_MAR_rctMAR01_rweMAR05_samesize}
methods <- c("glm")
nb_mi <- c(5,10)

if (!results_exist) {
  results_mlmi <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions, n = n, m = n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
          
  method=methods, nb_strat=1, 
                                            do_mi=T, nb_mi=nb_mi, strategy="multi-level-woY",
                                            verbose=T, verbose_intern = F)
      tmp$strategy <- "multi-level-woY"
      tmp$n <- n
      tmp$link <- link
      results_mlmi <- rbind(results_mlmi, tmp)
    }
  }
}
```

```{r save_mlmi_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
if (!results_exist) {
  save(results_mlmi, file=paste0(results_dir, "results_rep",repetitions, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"), paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mlmi_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
tmp <- results_mlmi %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

if (access_genRCT) {
  tmp <- tmp[,names(tmp) %in% c("CW", "AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW","CW"))
} else {
  tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method", "nb_mi", "n_effective", "m_effective", "strategy")]
  tmp <- melt(tmp,(ncol(tmp)-7):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
  tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))
}

tt <- tmp %>% group_by(method, n, link, nb_mi, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias", "nb_mi", "strategy", "n", "method", "link")) %>% filter(nb_mi==max(nb_mi)) %>% filter(n %in% c(min(n), max(n))) %>% unique()

print(paste0("results_rep",repetitions, "_diffpropNA_samesize_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_multilevelmi_nbMI",paste(nb_mi, sep="", collapse="_"),"_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable, linetype=as.factor(nb_mi))) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using multilevel MI, under MAR")) +
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-samesize-noCIS-multilevel-mi.pdf"), 
       width=8.8, height=6.8)
```


#### Use MIA to handle incomplete cases

```{r loadData_mia_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
methods <- c("grf")
results_exist <- FALSE

if (file.exists(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))){
  load(paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
  results_exist <- TRUE
} 
```

```{r comp_mia_noCIS_MAR_rctMAR01_rweMAR05_samesize}
methods <- c("grf")

if (!results_exist) {
  results_mia <- c()
  for (link in links){
    for (n in n_range){
      tmp <- compute_estimators_and_store(rep = repetitions_long, n = n, m = n, link=link, bs0=bs0,
                                          p = 4, Sigma = Sigma, snr=snr,
                                          na_rct=list(mechanism=mechanism[1], prop_miss=prop.miss[1], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          na_rwe=list(mechanism=mechanism[2], prop_miss=prop.miss[2], idx_incomplete=rep(1,4), cis=F, cio=F),
                                          method=methods, nb_strat=1, 
                                          verbose=T, verbose_intern = F)
      tmp$n <- n
      tmp$link <- link
      results_mia <- rbind(results_mia, tmp)
    }
  }
}
```

```{r save_mia_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
if (!results_exist) {
  save(results_mia, file=paste0(results_dir, "results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_noCIO_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_"),".RData"))
}
```

```{r plot_mia_noCIS_MAR_rctMAR01_rweMAR05_samesize, echo=F}
tmp <- results_mia %>% group_by(link, method) %>% mutate(tau=mean(tau)) %>% ungroup() %>% as.data.frame()

tmp <- tmp[,names(tmp) %in% c("AIPSW", "G.formula", "IPSW.norm", "RCT", "link", "tau", "n", "method",  "n_effective", "m_effective")]
tmp <- melt(tmp,(ncol(tmp)-5):ncol(tmp)) %>% mutate(variable=as.factor(gsub("G.formula","CO",as.character(variable))))  %>% filter(n %in% c(min(n), max(n)))
tmp$variable <- factor(tmp$variable, levels=c("RCT","IPSW.norm","CO","AIPSW"))

tt <- tmp %>% group_by(method, n, link, variable) %>% mutate(bias=mean(value)-mean(tau)) %>% ungroup() %>% dplyr::select(c("variable", "bias",  "n", "method", "link")) %>% unique()

print(paste0("results_rep",repetitions_long, "_diffpropNA_samesize_noCIS_link", paste(links,sep="",collapse="_"), "_snr",snr,"_", paste(mechanism,sep="",collapse="_"),"_propNA", paste(prop.miss,sep="",collapse="_"), "_cor", corX,"_n", paste(n_range,sep="",collapse="_"), "_mia_", paste(methods,sep="",collapse="_")))
print(tt)

ggplot(data = tmp, aes(x = variable, y = value)) + 
    geom_boxplot(aes(fill=variable)) +
    theme_bw() +
    geom_hline(aes(yintercept = tau, color = "Population ATE"), 
               size = 0.6, linetype="dashed") +
    xlab("") +
    ylab(paste0("Estimated ATE using MIA, under MAR")) + 
    theme(legend.title = element_blank(), 
          legend.text = element_text(size=14)) +  
    theme(axis.text = element_text(angle = 0, vjust = 0.5, 
                                   hjust=1, size=14)) + 
    theme(legend.key = element_rect(color = NA, fill = NA),           
          legend.position="bottom",           
          legend.box="vertical", legend.margin=margin(),          
          legend.key.size = unit(1, "cm")) + 
    guides(fill=FALSE) + 
    scale_fill_brewer(palette = "Accent") +
    coord_flip() + 
    facet_grid(.~n)

ggsave(paste0(fig_dir, Sys.Date(),"_",fig_prefix_long,"-simulation-", paste(mechanism,sep="",collapse="_"),"-",
              paste(prop.miss,sep="",collapse="_"),  "-corX",corX,"-diffpropNA-samesize-noCIS-mia.pdf"), 
       width=8.8, height=6.8)
```


